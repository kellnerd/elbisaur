# elbisaur

Command line app to manage your ListenBrainz listens and process listen dumps.

If you want to give it a try to see what you get, you can safely execute it with [Deno].
Run the following command to see its integrated help, Deno will prompt you for the necessary permissions:

```sh
deno run https://deno.land/x/listenbrainz/cli/elbisaur.ts
```

## Setup

If you don’t want to have to remember the URL and grant permissions every time, you can [install] it with the permissions specified as arguments:

```sh
deno install --allow-env=LB_USER,LB_TOKEN,ELBISAUR_LISTEN_TEMPLATE --allow-net=api.listenbrainz.org --allow-read --allow-write https://deno.land/x/listenbrainz/cli/elbisaur.ts
```

Now you can simply run the app by executing `elbisaur`, which should show you the help and complain about a missing required environment variable `LB_TOKEN`.
This is your ListenBrainz user token which is required to submit listens and can be obtained from your [ListenBrainz settings] page.
Running `elbisaur` automatically tries to load environment variables from a `.env` file in your working directory, so you can comfortably safe your LB user token inside there:

```conf
# example token below, insert your own
LB_TOKEN = "3b851ecc-474d-44eb-a4d0-db3bbb5ef8b8"
# user name is optional, but it sometimes safes an API request if it is specified
LB_USER = "Your LB user name here"
```

## Commands

elbisaur is a modular command line app with multiple subcommands which you can execute with `elbisaur <command>`.
The following commands are available:

| Command      | Description                                                            |
| ------------ | ---------------------------------------------------------------------- |
| `history`    | Show the listening history of yourself or another user                 |
| `delete`     | Delete listens in the given JSON file from your history                |
| `import`     | Import listens from the given JSON file                                |
| `listen`     | Submit listen for the given track metadata                             |
| `parse`      | [Parse listens](#parsers) from a file and write them into a JSONL file |
| `statistics` | Show statistics for the given JSON file                                |
| `transform`  | Modify listens from a JSON input file and write them into a JSONL file |

You can view the integrated help of each command with `elbisaur <command> --help`.

All commands which accept JSON files as input also accept JSONL files (one JSON object per line).
These should contain (one or multiple) serialized `Listen` objects as included in a ListenBrainz listening history export (and as shown by the ListenBrainz “Inspect listen” dialog).
JSONL files which are written by elbisaur also follow this format.

## Parsers

The following formats can be parsed by elbisaur (in addition to native JSON and JSONL listens):

- **.scrobbler.log** (`*.log`): Log file which is generated by some portable music players for later submission to Last.fm.
- **Spotify** (`*.json`): JSON files from an Extended Streaming History download.

See the [parser documentation](../README.md#parsers) for implementation details.

> [!NOTE]
> The parsers performs no filtering of listens, so you have to detect potential duplicates and skipped listens yourself.

## Examples

### Listening History

View your most recent listening history using the `history` command:

```sh
elbisaur history
```

In order to see the listening history of another user, specify their name with the `-u, --user` option:

```sh
elbisaur history --user listenbrainz
```

You can filter listens by listening time (`-a, --after` and `-b, --before`, happens on the server) and metadata (`-f, --filter`, happens locally).
If you want to apply metadata filters (locally), ensure that the API returns enough results by specifying a higher count with `-c, --count`.

Downloaded results can be stored as JSONL file by specifying an output path with `-o, --output`.
If the file already exists, the new listens will be appended to it.

Download your listens for all tracks by Jane Doe to which you listened on 17th January 2024:

```sh
elbisaur history -f "artist_name==Jane Doe" -a 2024-01-17 -b 2024-01-18 -c 200 -o jane.jsonl
```

[Deno]: https://deno.com/
[install]: https://docs.deno.com/runtime/manual/tools/script_installer
[ListenBrainz settings]: https://listenbrainz.org/settings/
