# listenbrainz

[Deno] library to access the [ListenBrainz API], written in TypeScript.

You can use it to submit your listening history to your [ListenBrainz] account.

As this library only makes use of web standards, it is also compatible with modern browsers (after transpilation to JavaScript).

## Features

- Submits listens and playing now notifications
- Browses your listening history and allows you to delete listens
- Handles ListenBrainz authorization and API errors
- Adheres to rate limits and optionally retries failed requests
- Provides generic `GET` and `POST` methods for (yet) unsupported API endpoints
- Includes additional [parsers](#parsers) to extract listens from text formats
- Ships with type definitions and inline [documentation]

## Usage

In order to submit listens, you have to specify a user token which you can obtain from your [ListenBrainz profile].

The following example instantiates a ListenBrainz client with a token from an environment variable and submits a [playing now] notification for a track:

```ts
import { ListenBrainzClient } from "https://deno.land/x/listenbrainz@v0.7.0/client.ts";

const client = new ListenBrainzClient({ userToken: Deno.env.get("LB_TOKEN") });
await client.playingNow({ artist_name: "John Doe", track_name: "Love Song" });
```

## elbisaur

`elbisaur` is a CLI which can be used to submit and manage listens (or as a more advanced example of the library’s usage).
You can safely execute it with [Deno] to see its integrated help, it will prompt you for the necessary permissions:

```sh
deno run https://deno.land/x/listenbrainz/cli/elbisaur.ts
```

Of course you can also directly specify the permissions as arguments and even [install] it (by replacing `run` with `install`):

```sh
deno install --allow-env=LB_USER,LB_TOKEN,ELBISAUR_LISTEN_TEMPLATE --allow-net=api.listenbrainz.org --allow-read --allow-write=. https://deno.land/x/listenbrainz/cli/elbisaur.ts
```

Running `elbisaur` automatically tries to load environment variables from a `.env` file in your working directory, so you can comfortably safe your LB user token inside there.

## Parsers

All listen parsers accept text input and generate `Listen` objects as their output.
These objects can then be used together with the ListenBrainz API and the LB client.
None of the parsers performs any filtering of listens, so you have to detect potential duplicates and skipped listens yourself.

The parsers do not include any logic to access files to make them platform independent.
You can pass them the content from a HTTP response body or from a Deno file, for example.

The following parsers are available in the `listenbrainz/parser/*.ts` submodules:

- **JSON**: Accepts a JSON-serialized `Listen` object (as shown by the LB “Inspect listen” dialog) or an array of `Listen` objects (format of a [LB listening history export]) as input.
- **JSONL**: Multiple JSON-serialized `Listen` objects, separated by line breaks.
- **.scrobbler.log**: TSV table document which is generated by some portable music players for later submission to Last.fm.
  - Parser currently accepts files with `AUDIOSCROBBLER/1.1` header which are generated by players with [Rockbox] firmware, possibly also by others.
  - Skipped listens are marked with `track_metadata.additional_info.skipped = true`.
- **Spotify**: JSON files from an Extended Streaming History download.
  - Skipped listens can be detected by their `track_metadata.additional_info` attributes `skipped`, `reason_end` and a too short `duration_ms`.

[Deno]: https://deno.com/
[documentation]: https://deno.land/x/listenbrainz?doc
[install]: https://docs.deno.com/runtime/manual/tools/script_installer
[ListenBrainz]: https://listenbrainz.org/
[ListenBrainz API]: https://listenbrainz.readthedocs.io/en/latest/users/api/index.html
[ListenBrainz profile]: https://listenbrainz.org/profile/
[LB listening history export]: https://listenbrainz.org/profile/export/
[playing now]: https://listenbrainz.org/listening-now/
[Rockbox]: https://www.rockbox.org/wiki/LastFMLog
